<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TG Memory Duo</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #ffffff);
            --text-color: var(--tg-theme-text-color, #000000);
            --hint-color: var(--tg-theme-hint-color, #999999);
            --button-color: var(--tg-theme-button-color, #2481cc);
        }

        body {
            margin: 0;
            padding: 10px;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #status {
            margin: 10px 0;
            font-weight: bold;
            text-align: center;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .player-info { padding: 5px 10px; border-radius: 8px; }
        .active-p { background: var(--button-color); color: white; }

        /* –°—ñ—Ç–∫–∞ –≥—Ä–∏ */
        .game-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            max-width: 350px;
            width: 100%;
        }

        .card {
            aspect-ratio: 1;
            background-color: var(--button-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: transparent;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
        }

        .card.flipped {
            background-color: var(--hint-color);
            color: white;
            transform: rotateY(180deg);
        }

        .card.matched {
            background-color: #4CAF50;
            visibility: visible;
            color: white;
        }

        #timer-container {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 10px 0;
            padding: 5px 20px;
            border-radius: 20px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
        }

        .low-time {
            color: #e74c3c;
            animation: blink 0.5s infinite alternate;
        }

        @keyframes blink {
            from { opacity: 1; }
            to { opacity: 0.5; }
        }
    </style>
</head>
<body>

    <div id="status">–ß–µ—Ä–≥–∞ –ì—Ä–∞–≤—Ü—è 1</div>
    <div id="timer-container">
        –ß–∞—Å: <span id="timer-value">60</span>—Å
    </div>
    <div class="stats">
        <div id="p1-info" class="player-info active-p">–ü1: <span id="p1-score">0</span></div>
        <div id="p2-info" class="player-info">–ü2: <span id="p2-score">0</span></div>
    </div>

    <div class="game-grid" id="grid"></div>

    <button id="share-btn">–ó–∞–ø—Ä–æ—Å–∏—Ç–∏ –¥—Ä—É–≥–∞</button>

    <script>

        document.getElementById('share-btn').addEventListener('click', () => {
            const inviteLink = `https://t.me/–í–ê–®_–ë–û–¢/app_name?startapp=${roomId}`;
            tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(inviteLink)}&text=–î–∞–≤–∞–π –∑—ñ–≥—Ä–∞—î–º–æ –≤ Memory!`);
        });

        const socket = io("https://teletest-nr8k.onrender.com");
        // –û—Ç—Ä–∏–º—É—î–º–æ ID –∫—ñ–º–Ω–∞—Ç–∏ –∑ –ø–æ—Å–∏–ª–∞–Ω–Ω—è Telegram (t.me/bot?startapp=room123)
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = tg.initDataUnsafe.start_param || "lobby";

        socket.emit('join_room', roomId);

        /*socket.on("opponentFlip", (cardIndex) => {
            const card = document.querySelector(`[data-index="${cardIndex}"]`);
            flipCard(card, false); // false ‚Äî —â–æ–± –Ω–µ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏ –ø–æ–¥—ñ—é –Ω–∞–∑–∞–¥
        });*/

        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        tg.onEvent('mainButtonClicked', () => {
            location.reload();
        });

        const allIcons = ['üçé', 'üçå', 'üçí', 'ü•ë', 'ü•¶', 'üçì', 'üçã', 'üçá', 'üçâ', 'üçç', 'ü•≠', 'ü•ù', 'üåΩ', 'ü•ï', 'ü•î', 'üçÑ', 'üçî', 'üçï', 'üåÆ', 'üç£', 'üç¶', 'üç©', 'üç™', 'üç´'];

        // –í–∏–±–∏—Ä–∞—î–º–æ –ø–æ—Ç—Ä—ñ–±–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ä–æ–∑–º—ñ—Ä—É
        const rows = 6;
        const cols = 6; // –∞–±–æ 8
        const totalPairs = (rows * cols) / 2;
        const selectedIcons = allIcons.slice(0, totalPairs);
        let cards = [...selectedIcons, ...selectedIcons];

        let flippedCards = [];
        let scores = [0, 0];
        let currentPlayer = 0; // 0 –∞–±–æ 1
        let canClick = true;

        // –ü–µ—Ä–µ–º—ñ—à—É–≤–∞–Ω–Ω—è
        cards.sort(() => Math.random() - 0.5);

        const grid = document.getElementById('grid');
        const status = document.getElementById('status');

        let timeLeft = 120; // –ß–∞—Å —É —Å–µ–∫—É–Ω–¥–∞—Ö
        let timerId = null;
        const timerDisplay = document.getElementById('timer-value');

        let myTurn = false;

        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–∞—Ä—Ç–æ–∫
        cards.forEach((icon, index) => {
            const card = document.createElement('div');
            card.classList.add('card');
            card.dataset.icon = icon;
            card.dataset.index = index;
            card.innerText = icon;
            card.addEventListener('click', () => flipCard(card));
            grid.appendChild(card);
        });

        function flipCard(card, isLocal = true) {
            if (isLocal) {
                socket.emit("cardFlip", { roomId, cardIndex: card.dataset.index });
            }
            startTimer(); // –ó–∞–ø—É—Å—Ç–∏—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω —Ä–∞–∑ –∑–∞–≤–¥—è–∫–∏ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ
            if (!canClick || card.classList.contains('flipped') || card.classList.contains('matched')) return;

            card.classList.add('flipped');
            flippedCards.push(card);

            if (flippedCards.length === 2) {
                canClick = false;
                checkMatch();
            }
        }

        function sendMove(cardIndex) {
            socket.emit('move', {
                roomId: roomId,
                cardIndex: cardIndex,
                player: tg.initDataUnsafe.user?.first_name || "–ì—Ä–∞–≤–µ—Ü—å"
            });
        }

        // –°–ª—É—Ö–∞—î–º–æ —Ö–æ–¥–∏ —Å—É–ø–µ—Ä–Ω–∏–∫–∞
        socket.on('opponent_move', (data) => {
            const card = document.querySelector(`[data-index="${data.cardIndex}"]`);
            if (card && !card.classList.contains('flipped')) {
                // –í–∏–∫–ª–∏–∫–∞—î–º–æ –≤–∞—à—É —Ñ—É–Ω–∫—Ü—ñ—é –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç—É, –∞–ª–µ –∑ –º—ñ—Ç–∫–æ—é,
                // —â–æ —Ü–µ –ø—Ä–∏–π—à–ª–æ –∑ –º–µ—Ä–µ–∂—ñ (—â–æ–± –Ω–µ –∑–∞—Ü–∏–∫–ª–∏—Ç–∏)
                flipCard(card, false);
            }
        });

        // –ß–µ–∫–∞—î–º–æ –Ω–∞ —Å—Ç–∞—Ä—Ç –≥—Ä–∏ –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞
        socket.on('init_game', (data) => {
            const deck = data.deck;
            myTurn = (socket.id === data.firstTurn);
            renderGrid(deck);
            updateStatus();
        });

        function renderGrid(deck) {
            const grid = document.getElementById('grid');
            grid.innerHTML = ''; // –û—á–∏—â—É—î–º–æ —Å—Ç–∞—Ä—É —Å—ñ—Ç–∫—É

            deck.forEach((icon, index) => {
                const card = document.createElement('div');
                card.classList.add('card');
                card.dataset.icon = icon;
                card.dataset.index = index;
                card.innerText = icon;
                card.addEventListener('click', () => {
                    if (myTurn) {
                        flipCard(card, true);
                        socket.emit('move', { roomId, cardIndex: index });
                    }
                });
                grid.appendChild(card);
            });
        }

        function updateStatus() {
            const status = document.getElementById('status');
            status.innerText = myTurn ? "–¢–≤—ñ–π —Ö—ñ–¥!" : "–•—ñ–¥ —Å—É–ø–µ—Ä–Ω–∏–∫–∞...";
        }

        // –ö–æ–ª–∏ —Å—É–ø–µ—Ä–Ω–∏–∫ –ø–æ—Ö–æ–¥–∏–≤
        socket.on('opponent_move', (data) => {
            const card = document.querySelector(`[data-index="${data.cardIndex}"]`);
            flipCard(card, false);
            myTurn = true; // –¢–µ–ø–µ—Ä –Ω–∞—à–∞ —á–µ—Ä–≥–∞
            updateStatus();
        });

        function checkMatch() {
            const [c1, c2] = flippedCards;
            const isMatch = c1.dataset.icon === c2.dataset.icon;

            if (isMatch) {
                c1.classList.add('matched');
                c2.classList.add('matched');
                scores[currentPlayer]++;
                updateUI();
                resetTurn(true);
            } else {
                setTimeout(() => {
                    c1.classList.remove('flipped');
                    c2.classList.remove('flipped');
                    currentPlayer = currentPlayer === 0 ? 1 : 0;
                    updateUI();
                    resetTurn(false);
                }, 1000);
            }
        }

        function resetTurn(keepPlayer) {
            flippedCards = [];
            canClick = true;
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');

            if (document.querySelectorAll('.matched').length === cards.length) {
                status.innerText = "–ì—Ä—É –∑–∞–∫—ñ–Ω—á–µ–Ω–æ!";
            }
        }

        function updateUI() {
            document.getElementById('p1-score').innerText = scores[0];
            document.getElementById('p2-score').innerText = scores[1];

            document.getElementById('p1-info').classList.toggle('active-p', currentPlayer === 0);
            document.getElementById('p2-info').classList.toggle('active-p', currentPlayer === 1);
            status.innerText = `–ß–µ—Ä–≥–∞ –ì—Ä–∞–≤—Ü—è ${currentPlayer + 1}`;
        }


        function startTimer() {
            if (timerId) return; // –Ø–∫—â–æ —Ç–∞–π–º–µ—Ä —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∏–π, –Ω—ñ—á–æ–≥–æ –Ω–µ —Ä–æ–±–∏–º–æ

            timerId = setInterval(() => {
                timeLeft--;
                timerDisplay.innerText = timeLeft;

                // –í—ñ–∑—É–∞–ª—å–Ω–µ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è, —è–∫—â–æ –∑–∞–ª–∏—à–∏–ª–æ—Å—è –º–µ–Ω—à–µ 10 —Å–µ–∫—É–Ω–¥
                if (timeLeft <= 10) {
                    document.getElementById('timer-container').classList.add('low-time');
                }

                if (timeLeft <= 0) {
                    clearInterval(timerId);
                    endGame("–ß–∞—Å –≤–∏—á–µ—Ä–ø–∞–Ω–æ!");
                }
            }, 1000);
        }

        function endGame(reason) {
            canClick = false;
            let winnerText = "";
            if (scores[0] > scores[1]) winnerText = "–ì—Ä–∞–≤–µ—Ü—å 1 –ø–µ—Ä–µ–º—ñ–≥!";
            else if (scores[1] > scores[0]) winnerText = "–ì—Ä–∞–≤–µ—Ü—å 2 –ø–µ—Ä–µ–º—ñ–≥!";
            else winnerText = "–ù—ñ—á–∏—è!";

            status.innerHTML = `‚ö†Ô∏è ${reason}<br>${winnerText}`;

            // –ü–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É –≤ Telegram
            tg.MainButton.setText("–ì—Ä–∞—Ç–∏ –∑–Ω–æ–≤—É");
            tg.MainButton.show();
        }
    </script>
</body>
</html>