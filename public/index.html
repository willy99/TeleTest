<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TG Memory Duo</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #ffffff);
            --text-color: var(--tg-theme-text-color, #000000);
            --hint-color: var(--tg-theme-hint-color, #999999);
            --button-color: var(--tg-theme-button-color, #2481cc);
        }
        body { margin: 0; padding: 10px; background-color: var(--bg-color); color: var(--text-color); font-family: sans-serif; display: flex; flex-direction: column; align-items: center; }
        #status { margin: 10px 0; font-weight: bold; height: 20px; }
        .stats { display: flex; gap: 20px; margin-bottom: 15px; }
        .player-info { padding: 5px 10px; border-radius: 8px; border: 1px solid var(--hint-color); }
        .active-p { background: var(--button-color); color: white; border: none; }
        .game-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; width: 100%; max-width: 400px; }
        .card { aspect-ratio: 1; background-color: var(--button-color); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: transparent; cursor: pointer; }
        .card.flipped { background-color: var(--hint-color); color: white; }
        .card.matched { background-color: #4CAF50; color: white; cursor: default; }
        #timer-container { font-size: 1.2rem; margin: 10px 0; }
        #share-btn { margin-top: 20px; padding: 10px 20px; background: var(--button-color); color: white; border: none; border-radius: 8px; }
    </style>
</head>
<body>

    <div id="status">Очікування суперника...</div>
    <div id="timer-container">Час: <span id="timer-value">120</span>с</div>

    <div class="stats">
        <div id="p1-info" class="player-info">Ви: <span id="p1-score">0</span></div>
        <div id="p2-info" class="player-info">Суперник: <span id="p2-score">0</span></div>
    </div>

    <div class="game-grid" id="grid"></div>
    <button id="share-btn">Запросити друга</button>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const socket = io(); // Підключається до того ж домену
        const roomId = new URLSearchParams(window.location.search).get('startapp') || tg.initDataUnsafe.start_param || "lobby";

        let myTurn = false;
        let scores = [0, 0];
        let flippedCards = [];
        let canClick = false;
        let timeLeft = 120;
        let timerId = null;

        socket.emit('join_room', roomId);

        document.getElementById('share-btn').onclick = () => {
            const botName = "willy2005_test_bot"; // ЗАМІНІТЬ НА СВОГО БОТА
            const inviteLink = `https://t.me/${botName}/app?startapp=${roomId}`;
            tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(inviteLink)}&text=Зіграй зі мною в Memory!`);
        };

        socket.on('init_game', (data) => {
            myTurn = (socket.id === data.firstTurn);
            renderGrid(data.deck);
            canClick = true;
            startTimer();
            updateUI();
        });

        function renderGrid(deck) {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            deck.forEach((icon, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.icon = icon;
                card.dataset.index = index;
                card.innerText = icon;
                card.onclick = () => handleCardClick(card);
                grid.appendChild(card);
            });
        }

        function handleCardClick(card) {
            if (!myTurn || !canClick || card.classList.contains('flipped') || card.classList.contains('matched')) return;

            flipCard(card);
            socket.emit('move', { roomId, cardIndex: card.dataset.index });
        }

        socket.on('opponent_move', (data) => {
            const card = document.querySelector(`[data-index="${data.cardIndex}"]`);
            flipCard(card);
        });

        function flipCard(card) {
            card.classList.add('flipped');
            flippedCards.push(card);

            if (flippedCards.length === 2) {
                canClick = false;
                setTimeout(checkMatch, 700);
            }
        }

        function checkMatch() {
            const [c1, c2] = flippedCards;
            const isMatch = c1.dataset.icon === c2.dataset.icon;

            if (isMatch) {
                c1.classList.add('matched');
                c2.classList.add('matched');
                if (myTurn) scores[0]++; else scores[1]++;
            } else {
                c1.classList.remove('flipped');
                c2.classList.remove('flipped');
                myTurn = !myTurn;
            }

            flippedCards = [];
            canClick = true;
            updateUI();

            if (document.querySelectorAll('.matched').length === 36) endGame("Всі пари знайдено!");
        }

        function updateUI() {
            document.getElementById('p1-score').innerText = scores[0];
            document.getElementById('p2-score').innerText = scores[1];
            document.getElementById('status').innerText = myTurn ? "Твій хід!" : "Хід суперника...";
            document.getElementById('p1-info').className = myTurn ? 'player-info active-p' : 'player-info';
            document.getElementById('p2-info').className = !myTurn ? 'player-info active-p' : 'player-info';
        }

        function startTimer() {
            if (timerId) return;
            timerId = setInterval(() => {
                timeLeft--;
                document.getElementById('timer-value').innerText = timeLeft;
                if (timeLeft <= 0) endGame("Час вийшов!");
            }, 1000);
        }

        function endGame(msg) {
            clearInterval(timerId);
            canClick = false;
            document.getElementById('status').innerText = msg;
            tg.MainButton.setText("Грати знову").show();
            tg.MainButton.onClick(() => location.reload());
        }
    </script>
</body>
</html>